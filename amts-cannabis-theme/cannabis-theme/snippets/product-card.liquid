{% comment %}
  Product Card Snippet
  Reusable cannabis product card with strain badges, potency display, effects, and quick add.

  Usage:
  {% render 'product-card', product: product, show_quick_add: true, show_effects: true %}

  Parameters:
  - product: (required) The product object
  - show_quick_add: (optional) Show quick add button, default: true
  - show_effects: (optional) Show effects preview, default: true
  - show_grade: (optional) Show product grade badge, default: true
  - card_class: (optional) Additional CSS classes
  - image_ratio: (optional) Image aspect ratio, default: 'square'
  - lazy_load: (optional) Lazy load images, default: true
{% endcomment %}

{% assign show_quick_add = show_quick_add | default: settings.show_quick_add | default: true %}
{% assign show_effects = show_effects | default: settings.show_effects_preview | default: true %}
{% assign show_grade = show_grade | default: settings.show_product_grade | default: true %}
{% assign image_ratio = image_ratio | default: 'square' %}
{% assign lazy_load = lazy_load | default: true %}

{% comment %} Get cannabis metafields {% endcomment %}
{% assign strain_type = product.metafields.cannabis.strain_type %}
{% assign thc = product.metafields.cannabis.thc_percentage %}
{% assign cbd = product.metafields.cannabis.cbd_percentage %}
{% assign thca = product.metafields.cannabis.thca_percentage %}
{% assign effects = product.metafields.cannabis.effects %}
{% assign product_grade = product.metafields.cannabis.product_grade %}

{% comment %} Strain type class for styling {% endcomment %}
{% assign strain_class = strain_type | downcase | replace: ' ', '-' | replace: '_', '-' %}

<div class="product-card {{ card_class }}" data-product-id="{{ product.id }}">
  <div class="product-card__media">
    <a href="{{ product.url }}" class="product-card__link" aria-label="{{ product.title }}">
      {% if product.featured_image %}
        <img
          src="{{ product.featured_image | image_url: width: 600 }}"
          alt="{{ product.featured_image.alt | default: product.title }}"
          width="300"
          height="300"
          class="product-card__image product-card__image--primary"
          {% if lazy_load %}loading="lazy"{% endif %}
        >
        {% if product.images.size > 1 %}
          <img
            src="{{ product.images[1] | image_url: width: 600 }}"
            alt="{{ product.images[1].alt | default: product.title }}"
            width="300"
            height="300"
            class="product-card__image product-card__image--secondary"
            loading="lazy"
          >
        {% endif %}
      {% else %}
        <div class="product-card__placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
          </svg>
        </div>
      {% endif %}
    </a>

    {% comment %} Badges overlay {% endcomment %}
    <div class="product-card__badges">
      {% if strain_type != blank and settings.show_strain_badge != false %}
        <span class="product-card__badge product-card__badge--strain strain-badge--{{ strain_class }}">
          {{ strain_type }}
        </span>
      {% endif %}

      {% if product_grade != blank and show_grade %}
        {% assign grade_class = product_grade | downcase | replace: ' ', '-' %}
        <span class="product-card__badge product-card__badge--grade grade-badge--{{ grade_class }}">
          {{ product_grade }}
        </span>
      {% endif %}

      {% if product.compare_at_price > product.price %}
        {% assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
        <span class="product-card__badge product-card__badge--sale">
          -{{ discount }}%
        </span>
      {% endif %}

      {% if product.available == false %}
        <span class="product-card__badge product-card__badge--soldout">
          Sold Out
        </span>
      {% endif %}
    </div>

    {% comment %} Quick add button {% endcomment %}
    {% if show_quick_add and product.available %}
      {% if product.variants.size == 1 %}
        <form method="post" action="/cart/add" class="product-card__quick-add-form">
          <input type="hidden" name="id" value="{{ product.variants.first.id }}">
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="product-card__quick-add" aria-label="Add {{ product.title }} to cart">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"/>
              <circle cx="20" cy="21" r="1"/>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            <span>Add to Cart</span>
          </button>
        </form>
      {% else %}
        <a href="{{ product.url }}" class="product-card__quick-add">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <span>View Options</span>
        </a>
      {% endif %}
    {% endif %}
  </div>

  <div class="product-card__info">
    {% comment %} Potency badges {% endcomment %}
    {% if thc != blank or cbd != blank or thca != blank %}
      <div class="product-card__potency">
        {% if thc != blank and settings.show_thc_percentage != false %}
          <span class="potency-badge potency-badge--thc">
            <span class="potency-badge__label">THC</span>
            <span class="potency-badge__value">{{ thc }}%</span>
          </span>
        {% endif %}
        {% if cbd != blank and settings.show_cbd_percentage != false %}
          <span class="potency-badge potency-badge--cbd">
            <span class="potency-badge__label">CBD</span>
            <span class="potency-badge__value">{{ cbd }}%</span>
          </span>
        {% endif %}
        {% if thca != blank %}
          <span class="potency-badge potency-badge--thca">
            <span class="potency-badge__label">THCA</span>
            <span class="potency-badge__value">{{ thca }}%</span>
          </span>
        {% endif %}
      </div>
    {% endif %}

    {% comment %} Product title {% endcomment %}
    <h3 class="product-card__title">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    {% comment %} Vendor {% endcomment %}
    {% if product.vendor != blank %}
      <p class="product-card__vendor">{{ product.vendor }}</p>
    {% endif %}

    {% comment %} Effects preview {% endcomment %}
    {% if effects != blank and show_effects %}
      {% assign effects_array = effects | split: ',' %}
      <div class="product-card__effects">
        {% for effect in effects_array limit: 3 %}
          <span class="product-card__effect">{{ effect | strip }}</span>
        {% endfor %}
        {% if effects_array.size > 3 %}
          <span class="product-card__effect product-card__effect--more">+{{ effects_array.size | minus: 3 }}</span>
        {% endif %}
      </div>
    {% endif %}

    {% comment %} Price {% endcomment %}
    <div class="product-card__price">
      {% if product.compare_at_price > product.price %}
        <span class="product-card__price-compare">{{ product.compare_at_price | money }}</span>
      {% endif %}
      <span class="product-card__price-current {% if product.compare_at_price > product.price %}product-card__price-current--sale{% endif %}">
        {% if product.price_varies %}
          From {{ product.price_min | money }}
        {% else %}
          {{ product.price | money }}
        {% endif %}
      </span>
    </div>

    {% comment %} Variant options preview {% endcomment %}
    {% if product.variants.size > 1 and product.options.size > 0 %}
      <div class="product-card__variants">
        {% assign option_name = product.options.first | downcase %}
        {% if option_name contains 'weight' or option_name contains 'size' or option_name contains 'amount' %}
          {% for variant in product.variants limit: 4 %}
            <span class="product-card__variant-option {% if variant.available == false %}product-card__variant-option--unavailable{% endif %}">
              {{ variant.option1 }}
            </span>
          {% endfor %}
          {% if product.variants.size > 4 %}
            <span class="product-card__variant-option product-card__variant-option--more">
              +{{ product.variants.size | minus: 4 }}
            </span>
          {% endif %}
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<style>
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
    background-color: var(--color-background-secondary, #1a1a2e);
    border-radius: var(--border-radius-medium, 12px);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.3);
  }

  .product-card__media {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    background-color: rgba(255, 255, 255, 0.03);
  }

  .product-card__link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease, opacity 0.3s ease;
  }

  .product-card__image--secondary {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
  }

  .product-card:hover .product-card__image--primary {
    transform: scale(1.05);
  }

  .product-card:hover .product-card__image--secondary {
    opacity: 1;
  }

  .product-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted, #9ca3af);
  }

  /* Badges */
  .product-card__badges {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    max-width: calc(100% - 1.5rem);
    z-index: 2;
  }

  .product-card__badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
    line-height: 1;
  }

  .product-card__badge--sale {
    background-color: #ef4444;
  }

  .product-card__badge--soldout {
    background-color: #6b7280;
  }

  /* Strain badges */
  .strain-badge--indica { background-color: var(--color-indica, #8b5cf6); }
  .strain-badge--sativa { background-color: var(--color-sativa, #f97316); }
  .strain-badge--hybrid { background-color: var(--color-hybrid, #22c55e); }
  .strain-badge--cbd { background-color: var(--color-cbd, #3b82f6); }
  .strain-badge--thca { background-color: var(--color-thca, #eab308); }
  .strain-badge--delta-9-hemp { background-color: var(--color-delta9, #06b6d4); }

  /* Grade badges */
  .grade-badge--budget { background-color: var(--color-grade-budget, #6b7280); }
  .grade-badge--mid-tier { background-color: var(--color-grade-mid, #10b981); }
  .grade-badge--premium { background-color: var(--color-grade-premium, #f59e0b); }
  .grade-badge--exotic { background-color: var(--color-grade-exotic, #ef4444); }

  /* Quick add */
  .product-card__quick-add {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: linear-gradient(135deg, var(--color-primary, #10b981), var(--color-secondary, #059669));
    color: white;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }

  .product-card:hover .product-card__quick-add,
  .product-card:focus-within .product-card__quick-add {
    transform: translateY(0);
  }

  .product-card__quick-add:hover {
    filter: brightness(1.1);
  }

  .product-card__quick-add-form {
    display: contents;
  }

  /* Info section */
  .product-card__info {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
  }

  /* Potency badges */
  .product-card__potency {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .potency-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background-color: rgba(255, 255, 255, 0.08);
    border-radius: var(--border-radius-small, 8px);
    font-size: 0.6875rem;
    font-weight: 600;
  }

  .potency-badge__label {
    opacity: 0.7;
  }

  .potency-badge--thc { color: var(--color-hybrid, #22c55e); }
  .potency-badge--cbd { color: var(--color-cbd, #3b82f6); }
  .potency-badge--thca { color: var(--color-thca, #eab308); }

  /* Title */
  .product-card__title {
    font-family: var(--font-heading, 'Poppins', sans-serif);
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.3;
    margin: 0;
  }

  .product-card__title a {
    color: var(--color-text, #ffffff);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .product-card__title a:hover {
    color: var(--color-primary, #10b981);
  }

  /* Vendor */
  .product-card__vendor {
    font-size: 0.75rem;
    color: var(--color-text-muted, #9ca3af);
    margin: 0;
  }

  /* Effects */
  .product-card__effects {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .product-card__effect {
    padding: 0.125rem 0.375rem;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    font-size: 0.625rem;
    color: var(--color-text-muted, #9ca3af);
    text-transform: capitalize;
  }

  .product-card__effect--more {
    background-color: var(--color-primary, #10b981);
    border-color: var(--color-primary, #10b981);
    color: white;
  }

  /* Price */
  .product-card__price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: 0.5rem;
  }

  .product-card__price-current {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text, #ffffff);
  }

  .product-card__price-current--sale {
    color: #ef4444;
  }

  .product-card__price-compare {
    font-size: 0.875rem;
    color: var(--color-text-muted, #9ca3af);
    text-decoration: line-through;
  }

  /* Variant options */
  .product-card__variants {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.25rem;
  }

  .product-card__variant-option {
    padding: 0.125rem 0.375rem;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    font-size: 0.625rem;
    color: var(--color-text-muted, #9ca3af);
  }

  .product-card__variant-option--unavailable {
    opacity: 0.5;
    text-decoration: line-through;
  }

  .product-card__variant-option--more {
    background-color: rgba(16, 185, 129, 0.2);
    color: var(--color-primary, #10b981);
  }

  /* Mobile */
  @media (max-width: 480px) {
    .product-card__title {
      font-size: 0.875rem;
    }

    .product-card__quick-add {
      transform: translateY(0);
      position: relative;
      margin: 0.75rem;
      border-radius: var(--border-radius-small, 8px);
    }

    .product-card__quick-add span {
      display: none;
    }
  }

  /* Touch devices */
  @media (hover: none) {
    .product-card__quick-add {
      transform: translateY(0);
    }
  }
</style>
