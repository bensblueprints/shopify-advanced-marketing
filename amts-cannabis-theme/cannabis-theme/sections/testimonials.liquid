{% comment %}
  Testimonials Section
  Customer reviews and testimonials carousel
{% endcomment %}

<section class="testimonials-section" id="testimonials-{{ section.id }}">
  <div class="testimonials-container">
    {% if section.settings.heading or section.settings.subheading %}
      <div class="section-header">
        {% if section.settings.pre_heading %}
          <span class="section-preheading">{{ section.settings.pre_heading }}</span>
        {% endif %}
        {% if section.settings.heading %}
          <h2 class="section-heading">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subheading %}
          <p class="section-subheading">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="testimonials-wrapper">
      {% if section.settings.layout == 'carousel' %}
        <button class="testimonial-nav testimonial-prev" aria-label="Previous">
          <svg width="24" height="24" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg>
        </button>
      {% endif %}

      <div class="testimonials-track-container">
        <div class="testimonials-track testimonials-{{ section.settings.layout }}" id="testimonials-track-{{ section.id }}">
          {% for block in section.blocks %}
            {% if block.type == 'testimonial' %}
              <div class="testimonial-slide" {{ block.shopify_attributes }}>
                <article class="testimonial-card">
                  <div class="testimonial-rating">
                    {% assign rating = block.settings.rating | default: 5 %}
                    {% for i in (1..5) %}
                      {% if i <= rating %}
                        <svg class="star filled" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/></svg>
                      {% else %}
                        <svg class="star" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" fill="none"/></svg>
                      {% endif %}
                    {% endfor %}
                  </div>

                  <blockquote class="testimonial-quote">
                    <p>"{{ block.settings.quote }}"</p>
                  </blockquote>

                  <div class="testimonial-author">
                    {% if block.settings.image %}
                      <img
                        src="{{ block.settings.image | img_url: '100x100', crop: 'center' }}"
                        alt="{{ block.settings.author }}"
                        class="author-image"
                        loading="lazy"
                      >
                    {% else %}
                      <div class="author-avatar" style="background: {{ block.settings.avatar_color | default: '#10b981' }};">
                        {{ block.settings.author | slice: 0 }}
                      </div>
                    {% endif %}
                    <div class="author-info">
                      <span class="author-name">{{ block.settings.author }}</span>
                      {% if block.settings.product %}
                        <span class="author-product">Purchased: {{ block.settings.product }}</span>
                      {% endif %}
                      {% if block.settings.verified %}
                        <span class="verified-badge">
                          <svg viewBox="0 0 20 20"><path d="M6 10l3 3 5-5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          Verified Purchase
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  {% if block.settings.date %}
                    <time class="testimonial-date">{{ block.settings.date }}</time>
                  {% endif %}
                </article>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      {% if section.settings.layout == 'carousel' %}
        <button class="testimonial-nav testimonial-next" aria-label="Next">
          <svg width="24" height="24" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" fill="none"/></svg>
        </button>
      {% endif %}
    </div>

    {% if section.settings.layout == 'carousel' and section.settings.show_dots %}
      <div class="testimonial-dots" id="testimonial-dots-{{ section.id }}"></div>
    {% endif %}

    {% if section.settings.show_cta %}
      <div class="testimonials-cta">
        <a href="{{ section.settings.cta_link | default: '/collections/all' }}" class="btn-testimonial-cta">
          {{ section.settings.cta_text | default: 'Shop Now' }}
        </a>
      </div>
    {% endif %}
  </div>
</section>

<style>
  .testimonials-section {
    padding: {{ section.settings.padding_top | default: 80 }}px 2rem {{ section.settings.padding_bottom | default: 80 }}px;
    background: {{ section.settings.background_color | default: '#f9fafb' }};
  }

  .testimonials-container {
    max-width: var(--page-width, 1400px);
    margin: 0 auto;
  }

  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .section-preheading {
    display: block;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: {{ section.settings.accent_color | default: '#10b981' }};
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .section-heading {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 800;
    margin: 0 0 0.75rem;
    color: {{ section.settings.heading_color | default: '#111827' }};
  }

  .section-subheading {
    font-size: 1.125rem;
    color: {{ section.settings.text_color | default: '#6b7280' }};
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* Testimonials Wrapper */
  .testimonials-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .testimonial-nav {
    position: absolute;
    z-index: 10;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: white;
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    color: #374151;
  }

  .testimonial-nav:hover {
    background: {{ section.settings.accent_color | default: '#10b981' }};
    border-color: {{ section.settings.accent_color | default: '#10b981' }};
    color: white;
  }

  .testimonial-prev { left: -24px; }
  .testimonial-next { right: -24px; }

  .testimonials-track-container {
    flex: 1;
    overflow: hidden;
  }

  .testimonials-track {
    display: flex;
    gap: 1.5rem;
    transition: transform 0.4s ease;
  }

  .testimonials-track.testimonials-carousel .testimonial-slide {
    flex: 0 0 calc(33.333% - 1rem);
    min-width: 300px;
  }

  .testimonials-track.testimonials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  /* Testimonial Card */
  .testimonial-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
    border: 1px solid #f3f4f6;
  }

  .testimonial-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
  }

  .testimonial-rating {
    display: flex;
    gap: 4px;
    margin-bottom: 1rem;
  }

  .testimonial-rating svg {
    width: 18px;
    height: 18px;
  }

  .star.filled {
    color: #fbbf24;
  }

  .star {
    color: #e5e7eb;
  }

  .testimonial-quote {
    flex: 1;
    margin: 0 0 1.5rem;
  }

  .testimonial-quote p {
    font-size: 1.0625rem;
    line-height: 1.7;
    color: #374151;
    margin: 0;
    font-style: italic;
  }

  .testimonial-author {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .author-image {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
  }

  .author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.25rem;
    text-transform: uppercase;
  }

  .author-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .author-name {
    font-weight: 600;
    color: #111827;
  }

  .author-product {
    font-size: 0.8125rem;
    color: #6b7280;
  }

  .verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: {{ section.settings.accent_color | default: '#10b981' }};
    font-weight: 500;
  }

  .verified-badge svg {
    width: 14px;
    height: 14px;
  }

  .testimonial-date {
    display: block;
    margin-top: 1rem;
    font-size: 0.75rem;
    color: #9ca3af;
  }

  /* Dots */
  .testimonial-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
  }

  .testimonial-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #d1d5db;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .testimonial-dot.active {
    background: {{ section.settings.accent_color | default: '#10b981' }};
    transform: scale(1.2);
  }

  /* CTA */
  .testimonials-cta {
    text-align: center;
    margin-top: 2.5rem;
  }

  .btn-testimonial-cta {
    display: inline-block;
    padding: 1rem 2.5rem;
    background: {{ section.settings.accent_color | default: '#10b981' }};
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s;
  }

  .btn-testimonial-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
  }

  /* Mobile Responsive */
  @media (max-width: 1024px) {
    .testimonials-track.testimonials-carousel .testimonial-slide {
      flex: 0 0 calc(50% - 0.75rem);
    }

    .testimonial-nav {
      width: 40px;
      height: 40px;
    }

    .testimonial-prev { left: -10px; }
    .testimonial-next { right: -10px; }
  }

  @media (max-width: 640px) {
    .testimonials-section {
      padding: 3rem 1rem;
    }

    .testimonials-track.testimonials-carousel .testimonial-slide {
      flex: 0 0 90%;
      min-width: 280px;
    }

    .testimonial-nav {
      display: none;
    }

    .testimonials-track-container {
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .testimonials-track-container::-webkit-scrollbar {
      display: none;
    }

    .testimonials-track.testimonials-carousel .testimonial-slide {
      scroll-snap-align: center;
    }

    .testimonials-track.testimonials-grid {
      grid-template-columns: 1fr;
    }

    .testimonial-card {
      padding: 1.5rem;
    }
  }
</style>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const track = document.getElementById(`testimonials-track-${sectionId}`);
    const isCarousel = track.classList.contains('testimonials-carousel');

    if (!isCarousel) return;

    const container = track.parentElement;
    const slides = track.querySelectorAll('.testimonial-slide');
    const prevBtn = container.parentElement.querySelector('.testimonial-prev');
    const nextBtn = container.parentElement.querySelector('.testimonial-next');
    const dotsContainer = document.getElementById(`testimonial-dots-${sectionId}`);

    let currentIndex = 0;

    function getSlidesPerView() {
      if (window.innerWidth <= 640) return 1;
      if (window.innerWidth <= 1024) return 2;
      return 3;
    }

    function updateCarousel() {
      const visibleSlides = getSlidesPerView();
      const maxIndex = Math.max(0, slides.length - visibleSlides);
      currentIndex = Math.min(currentIndex, maxIndex);

      const slideWidth = slides[0].offsetWidth + 24;
      track.style.transform = `translateX(-${currentIndex * slideWidth}px)`;

      if (prevBtn) prevBtn.disabled = currentIndex === 0;
      if (nextBtn) nextBtn.disabled = currentIndex >= maxIndex;

      if (dotsContainer) {
        const dots = dotsContainer.querySelectorAll('.testimonial-dot');
        dots.forEach((dot, i) => dot.classList.toggle('active', i === currentIndex));
      }
    }

    function createDots() {
      if (!dotsContainer) return;

      const visibleSlides = getSlidesPerView();
      const totalDots = Math.max(1, slides.length - visibleSlides + 1);

      dotsContainer.innerHTML = '';
      for (let i = 0; i < totalDots; i++) {
        const dot = document.createElement('button');
        dot.className = `testimonial-dot ${i === 0 ? 'active' : ''}`;
        dot.onclick = () => {
          currentIndex = i;
          updateCarousel();
        };
        dotsContainer.appendChild(dot);
      }
    }

    if (prevBtn) {
      prevBtn.onclick = () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      };
    }

    if (nextBtn) {
      nextBtn.onclick = () => {
        const visibleSlides = getSlidesPerView();
        if (currentIndex < slides.length - visibleSlides) {
          currentIndex++;
          updateCarousel();
        }
      };
    }

    window.addEventListener('resize', () => {
      createDots();
      updateCarousel();
    });

    createDots();
    updateCarousel();
  })();
</script>

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "testimonials",
  "max_blocks": 12,
  "settings": [
    {
      "type": "header",
      "content": "Section Header"
    },
    {
      "type": "text",
      "id": "pre_heading",
      "label": "Pre-heading",
      "default": "Reviews"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What Our Customers Say"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Real reviews from verified customers"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "options": [
        { "value": "carousel", "label": "Carousel" },
        { "value": "grid", "label": "Grid" }
      ],
      "default": "carousel"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show Navigation Dots",
      "default": true
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "checkbox",
      "id": "show_cta",
      "label": "Show CTA Button",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA Text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "CTA Link"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f9fafb"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#111827"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#6b7280"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color",
      "default": "#10b981"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding Top (px)",
      "min": 0,
      "max": 150,
      "step": 10,
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding Bottom (px)",
      "min": 0,
      "max": 150,
      "step": 10,
      "default": 80
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Author Image"
        },
        {
          "type": "color",
          "id": "avatar_color",
          "label": "Avatar Color (if no image)",
          "default": "#10b981"
        },
        {
          "type": "text",
          "id": "author",
          "label": "Author Name",
          "default": "John D."
        },
        {
          "type": "range",
          "id": "rating",
          "label": "Rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "Amazing quality! The effects are exactly as described and the shipping was fast and discreet."
        },
        {
          "type": "text",
          "id": "product",
          "label": "Product Purchased"
        },
        {
          "type": "checkbox",
          "id": "verified",
          "label": "Verified Purchase",
          "default": true
        },
        {
          "type": "text",
          "id": "date",
          "label": "Date",
          "default": "2 days ago"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "category": "Social Proof",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "author": "Sarah M.",
            "rating": 5,
            "quote": "Best dispensary I've found online! The flower is always fresh and potent. Customer service is top-notch.",
            "product": "Blue Dream",
            "verified": true,
            "date": "3 days ago"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "author": "Mike T.",
            "rating": 5,
            "quote": "Love the variety and quality. The COA on each product gives me confidence in what I'm purchasing.",
            "product": "OG Kush",
            "verified": true,
            "date": "1 week ago"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "author": "Jessica R.",
            "rating": 5,
            "quote": "Fast shipping and discreet packaging. The edibles are perfectly dosed and taste great!",
            "product": "Gummy Bears 10mg",
            "verified": true,
            "date": "2 weeks ago"
          }
        }
      ]
    }
  ]
}
{% endschema %}
